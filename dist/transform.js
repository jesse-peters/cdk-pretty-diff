"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.transformDiff = void 0;
const cfnDiff = require("@aws-cdk/cloudformation-diff");
const through2 = require("through2");
const util_1 = require("./util");
const types_1 = require("./types");
const cdk_reverse_engineered_1 = require("./cdk-reverse-engineered");
// unable to emulate the --no-colors option, (tried passing no-colors option to cdk Configuration class to no avail)
// this is workaround to remove the colors tty elements
const fixRemoveColors = (input) => JSON.parse(JSON.stringify(input).replace(/\\u001b\[[^m]+m/g, ''));
const buildRaw = async (diff) => {
    const strm = through2();
    cfnDiff.formatDifferences(strm, diff.rawDiff, diff.logicalToPathMap);
    strm.end();
    return fixRemoveColors(await (0, util_1.streamToString)(strm));
};
const buildChangeAction = (oldValue, newValue) => {
    if (oldValue !== undefined && newValue !== undefined) {
        return "UPDATE";
    }
    else if (oldValue !== undefined) {
        return "REMOVAL";
    }
    else {
        return "ADDITION";
    }
};
const transformIamChanges = async (diff) => {
    if (!diff.rawDiff.iamChanges.hasChanges) {
        return [];
    }
    const result = [];
    if (diff.rawDiff.iamChanges.statements.hasChanges) {
        const statementsSummarized = diff.rawDiff.iamChanges.summarizeStatements();
        result.push({
            label: "IAM Statement Changes",
            cdkDiffRaw: fixRemoveColors(cfnDiff.formatTable((0, cdk_reverse_engineered_1.deepSubstituteBracedLogicalIds)(diff.logicalToPathMap)(statementsSummarized), undefined)),
        });
    }
    if (diff.rawDiff.iamChanges.managedPolicies.hasChanges) {
        const managedPoliciesSummarized = diff.rawDiff.iamChanges.summarizeManagedPolicies();
        result.push({
            label: "IAM Policy Changes",
            cdkDiffRaw: fixRemoveColors(cfnDiff.formatTable((0, cdk_reverse_engineered_1.deepSubstituteBracedLogicalIds)(diff.logicalToPathMap)(managedPoliciesSummarized), undefined)),
        });
    }
    return result;
};
const transformSecurityGroupChanges = async (diff) => {
    if (!diff.rawDiff.securityGroupChanges.hasChanges) {
        return [];
    }
    const summarized = diff.rawDiff.securityGroupChanges.summarize();
    return [
        {
            label: "Security Group Changes",
            cdkDiffRaw: fixRemoveColors(cfnDiff.formatTable((0, cdk_reverse_engineered_1.deepSubstituteBracedLogicalIds)(diff.logicalToPathMap)(summarized), undefined)),
        },
    ];
};
const processIndividualDiff = (result, cdkDiffCategory) => (id, rdiff) => {
    var _a, _b, _c, _d;
    if (rdiff.isDifferent) {
        const resourceType = (0, types_1.guardResourceDiff)(rdiff)
            ? (rdiff.isRemoval ? (_a = rdiff.oldValue) === null || _a === void 0 ? void 0 : _a.Type : (_b = rdiff.newValue) === null || _b === void 0 ? void 0 : _b.Type) ||
                cdkDiffCategory
            : (((_c = rdiff.oldValue) === null || _c === void 0 ? void 0 : _c.Type) || ((_d = rdiff.newValue) === null || _d === void 0 ? void 0 : _d.Type) || cdkDiffCategory);
        const changes = [];
        if ((0, types_1.guardResourceDiff)(rdiff) && rdiff.isUpdate) {
            rdiff.forEachDifference((_, label, values) => {
                changes.push({
                    label,
                    action: buildChangeAction(values.oldValue, values.newValue),
                    from: values.oldValue,
                    to: values.newValue,
                });
            });
        }
        result.push({
            label: cdkDiffCategory,
            cdkDiffRaw: JSON.stringify({ id, diff: rdiff }, null, 2),
            nicerDiff: {
                resourceType,
                changes,
                cdkDiffCategory,
                resourceAction: rdiff.isAddition
                    ? "ADDITION"
                    : rdiff.isRemoval
                        ? "REMOVAL"
                        : "UPDATE",
                resourceLabel: id,
            },
        });
    }
};
const transformDiffForResourceTypes = async (diff) => {
    const result = [];
    for (const d of Object.entries(diff.rawDiff).filter(([k]) => !["iamChanges", "securityGroupChanges"].includes(k))) {
        const { diffCollectionKey, diffCollection } = (0, types_1.diffValidator)(d);
        if (diffCollection.differenceCount > 0) {
            diffCollection.forEachDifference(processIndividualDiff(result, diffCollectionKey));
        }
    }
    return result;
};
const transformDiff = async (diff) => {
    if (diff.rawDiff.isEmpty) {
        return {
            stackName: diff.stackName,
            raw: "There were no differences",
            diff: [],
        };
    }
    return {
        stackName: diff.stackName,
        raw: await buildRaw(diff),
        diff: [
            ...(await transformIamChanges(diff)),
            ...(await transformSecurityGroupChanges(diff)),
            ...(await transformDiffForResourceTypes(diff)),
        ],
    };
};
exports.transformDiff = transformDiff;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNmb3JtLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3RyYW5zZm9ybS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSx3REFBd0Q7QUFDeEQscUNBQXFDO0FBRXJDLGlDQUF3QztBQUN4QyxtQ0FRaUI7QUFDakIscUVBQTBFO0FBRTFFLG9IQUFvSDtBQUNwSCx1REFBdUQ7QUFDdkQsTUFBTSxlQUFlLEdBQUcsQ0FBQyxLQUFhLEVBQVUsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsa0JBQWtCLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQTtBQUVwSCxNQUFNLFFBQVEsR0FBRyxLQUFLLEVBQUUsSUFBa0IsRUFBbUIsRUFBRTtJQUM3RCxNQUFNLElBQUksR0FBRyxRQUFRLEVBQUUsQ0FBQztJQUN4QixPQUFPLENBQUMsaUJBQWlCLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDckUsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ1gsT0FBTyxlQUFlLENBQUMsTUFBTSxJQUFBLHFCQUFjLEVBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztBQUNyRCxDQUFDLENBQUM7QUFFRixNQUFNLGlCQUFpQixHQUFHLENBQUMsUUFBYSxFQUFFLFFBQWEsRUFBRSxFQUFFO0lBQ3pELElBQUksUUFBUSxLQUFLLFNBQVMsSUFBSSxRQUFRLEtBQUssU0FBUyxFQUFFO1FBQ3BELE9BQU8sUUFBUSxDQUFDO0tBQ2pCO1NBQU0sSUFBSSxRQUFRLEtBQUssU0FBUyxFQUFFO1FBQ2pDLE9BQU8sU0FBUyxDQUFDO0tBQ2xCO1NBQU07UUFDTCxPQUFPLFVBQVUsQ0FBQztLQUNuQjtBQUNILENBQUMsQ0FBQztBQUVGLE1BQU0sbUJBQW1CLEdBQUcsS0FBSyxFQUMvQixJQUFrQixFQUNJLEVB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LEVBQUMsQ0FBQyxDQUFDLENBQUM7UUFDL0QsSUFBSSxjQUFjLENBQUMsZUFBZSxHQUFHLENBQUMsRUFBRTtZQUN0QyxjQUFjLENBQUMsaUJBQWlCLENBQzlCLHFCQUFxQixDQUFDLE1BQU0sRUFBRSxpQkFBaUIsQ0FBQyxDQUNqRCxDQUFDO1NBQ0g7S0FDRjtJQUVELE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMsQ0FBQztBQUVLLE1BQU0sYUFBYSxHQUFHLEtBQUssRUFDaEMsSUFBa0IsRUFDTyxFQUFFO0lBQzNCLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUU7UUFDeEIsT0FBTztZQUNMLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztZQUN6QixHQUFHLEVBQUUsMkJBQTJCO1lBQ2hDLElBQUksRUFBRSxFQUFFO1NBQ1QsQ0FBQztLQUNIO0lBRUQsT0FBTztRQUNMLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztRQUN6QixHQUFHLEVBQUUsTUFBTSxRQUFRLENBQUMsSUFBSSxDQUFDO1FBQ3pCLElBQUksRUFBRTtZQUNKLEdBQUcsQ0FBQyxNQUFNLG1CQUFtQixDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3BDLEdBQUcsQ0FBQyxNQUFNLDZCQUE2QixDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzlDLEdBQUcsQ0FBQyxNQUFNLDZCQUE2QixDQUFDLElBQUksQ0FBQyxDQUFDO1NBQy9DO0tBQ0YsQ0FBQztBQUNKLENBQUMsQ0FBQztBQXBCVyxRQUFBLGFBQWEsaUJBb0J4QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNmbkRpZmYgZnJvbSBcIkBhd3MtY2RrL2Nsb3VkZm9ybWF0aW9uLWRpZmZcIjtcbmltcG9ydCAqIGFzIHRocm91Z2gyIGZyb20gXCJ0aHJvdWdoMlwiO1xuXG5pbXBvcnQgeyBzdHJlYW1Ub1N0cmluZyB9IGZyb20gXCIuL3V0aWxcIjtcbmltcG9ydCB7XG4gIENka0RpZmZDYXRlZ29yeSxcbiAgZGlmZlZhbGlkYXRvcixcbiAgZ3VhcmRSZXNvdXJjZURpZmYsXG4gIE5pY2VyRGlmZixcbiAgTmljZXJEaWZmQ2hhbmdlLFxuICBOaWNlclN0YWNrRGlmZixcbiAgU3RhY2tSYXdEaWZmLFxufSBmcm9tIFwiLi90eXBlc1wiO1xuaW1wb3J0IHsgZGVlcFN1YnN0aXR1dGVCcmFjZWRMb2dpY2FsSWRzIH0gZnJvbSBcIi4vY2RrLXJldmVyc2UtZW5naW5lZXJlZFwiO1xuXG4vLyB1bmFibGUgdG8gZW11bGF0ZSB0aGUgLS1uby1jb2xvcnMgb3B0aW9uLCAodHJpZWQgcGFzc2luZyBuby1jb2xvcnMgb3B0aW9uIHRvIGNkayBDb25maWd1cmF0aW9uIGNsYXNzIHRvIG5vIGF2YWlsKVxuLy8gdGhpcyBpcyB3b3JrYXJvdW5kIHRvIHJlbW92ZSB0aGUgY29sb3JzIHR0eSBlbGVtZW50c1xuY29uc3QgZml4UmVtb3ZlQ29sb3JzID0gKGlucHV0OiBzdHJpbmcpOiBzdHJpbmcgPT4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShpbnB1dCkucmVwbGFjZSgvXFxcXHUwMDFiXFxbW15tXSttL2csICcnKSlcblxuY29uc3QgYnVpbGRSYXcgPSBhc3luYyAoZGlmZjogU3RhY2tSYXdEaWZmKTogUHJvbWlzZTxzdHJpbmc+ID0+IHtcbiAgY29uc3Qgc3RybSA9IHRocm91Z2gyKCk7XG4gIGNmbkRpZmYuZm9ybWF0RGlmZmVyZW5jZXMoc3RybSwgZGlmZi5yYXdEaWZmLCBkaWZmLmxvZ2ljYWxUb1BhdGhNYXApO1xuICBzdHJtLmVuZCgpO1xuICByZXR1cm4gZml4UmVtb3ZlQ29sb3JzKGF3YWl0IHN0cmVhbVRvU3RyaW5nKHN0cm0pKTtcbn07XG5cbmNvbnN0IGJ1aWxkQ2hhbmdlQWN0aW9uID0gKG9sZFZhbHVlOiBhbnksIG5ld1ZhbHVlOiBhbnkpID0+IHtcbiAgaWYgKG9sZFZhbHVlICE9PSB1bmRlZmluZWQgJiYgbmV3VmFsdWUgIT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiBcIlVQREFURVwiO1xuICB9IGVsc2UgaWYgKG9sZFZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gXCJSRU1PVkFMXCI7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIFwiQURESVRJT05cIjtcbiAgfVxufTtcblxuY29uc3QgdHJhbnNmb3JtSWFtQ2hhbmdlcyA9IGFzeW5jIChcbiAgZGlmZjogU3RhY2tSYXdEaWZmXG4pOiBQcm9taXNlPE5pY2VyRGlmZltdPiA9PiB7XG4gIGlmICghZGlmZi5yYXdEaWZmLmlhbUNoYW5nZXMuaGFzQ2hhbmdlcykge1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIGNvbnN0IHJlc3VsdDogTmljZXJEaWZmW10gPSBbXTtcbiAgaWYgKGRpZmYucmF3RGlmZi5pYW1DaGFuZ2VzLnN0YXRlbWVudHMuaGFzQ2hhbmdlcykge1xuICAgIGNvbnN0IHN0YXRlbWVudHNTdW1tYXJpemVkID0gZGlmZi5yYXdEaWZmLmlhbUNoYW5nZXMuc3VtbWFyaXplU3RhdGVtZW50cygpO1xuICAgIHJlc3VsdC5wdXNoKHtcbiAgICAgIGxhYmVsOiBcIklBTSBTdGF0ZW1lbnQgQ2hhbmdlc1wiLFxuICAgICAgY2RrRGlmZlJhdzogZml4UmVtb3ZlQ29sb3JzKFxuICAgICAgICBjZm5EaWZmLmZvcm1hdFRhYmxlKFxuICAgICAgICAgIGRlZXBTdWJzdGl0dXRlQnJhY2VkTG9naWNhbElkcyhkaWZmLmxvZ2ljYWxUb1BhdGhNYXApKFxuICAgICAgICAgICAgc3RhdGVtZW50c1N1bW1hcml6ZWRcbiAgICAgICAgICApLFxuICAgICAgICAgIHVuZGVmaW5lZFxuICAgICAgICApXG4gICAgICApLFxuICAgIH0pO1xuICB9XG5cbiAgaWYgKGRpZmYucmF3RGlmZi5pYW1DaGFuZ2VzLm1hbmFnZWRQb2xpY2llcy5oYXNDaGFuZ2VzKSB7XG4gICAgY29uc3QgbWFuYWdlZFBvbGljaWVzU3VtbWFyaXplZCA9XG4gICAgICBkaWZmLnJhd0RpZmYuaWFtQ2hhbmdlcy5zdW1tYXJpemVNYW5hZ2VkUG9saWNpZXMoKTtcbiAgICByZXN1bHQucHVzaCh7XG4gICAgICBsYWJlbDogXCJJQU0gUG9saWN5IENoYW5nZXNcIixcbiAgICAgIGNka0RpZmZSYXc6IGZpeFJlbW92ZUNvbG9ycyhcbiAgICAgICAgY2ZuRGlmZi5mb3JtYXRUYWJsZShcbiAgICAgICAgICBkZWVwU3Vic3RpdHV0ZUJyYWNlZExvZ2ljYWxJZHMoZGlmZi5sb2dpY2FsVG9QYXRoTWFwKShcbiAgICAgICAgICAgIG1hbmFnZWRQb2xpY2llc1N1bW1hcml6ZWRcbiAgICAgICAgICApLFxuICAgICAgICAgIHVuZGVmaW5lZFxuICAgICAgICApXG4gICAgICApLFxuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn07XG5cbmNvbnN0IHRyYW5zZm9ybVNlY3VyaXR5R3JvdXBDaGFuZ2VzID0gYXN5bmMgKFxuICBkaWZmOiBTdGFja1Jhd0RpZmZcbik6IFByb21pc2U8TmljZXJEaWZmW10+ID0+IHtcbiAgaWYgKCFkaWZmLnJhd0RpZmYuc2VjdXJpdHlHcm91cENoYW5nZXMuaGFzQ2hhbmdlcykge1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIGNvbnN0IHN1bW1hcml6ZWQgPSBkaWZmLnJhd0RpZmYuc2VjdXJpdHlHcm91cENoYW5nZXMuc3VtbWFyaXplKCk7XG5cbiAgcmV0dXJuIFtcbiAgICB7XG4gICAgICBsYWJlbDogXCJTZWN1cml0eSBHcm91cCBDaGFuZ2VzXCIsXG4gICAgICBjZGtEaWZmUmF3OiBmaXhSZW1vdmVDb2xvcnMoXG4gICAgICAgIGNmbkRpZmYuZm9ybWF0VGFibGUoXG4gICAgICAgICAgZGVlcFN1YnN0aXR1dGVCcmFjZWRMb2dpY2FsSWRzKGRpZmYubG9naWNhbFRvUGF0aE1hcCkoc3VtbWFyaXplZCksXG4gICAgICAgICAgdW5kZWZpbmVkXG4gICAgICAgIClcbiAgICAgICksXG4gICAgfSxcbiAgXTtcbn07XG5cbmNvbnN0IHByb2Nlc3NJbmRpdmlkdWFsRGlmZiA9XG4gIChyZXN1bHQ6IE5pY2VyRGlmZltdLCBjZGtEaWZmQ2F0ZWdvcnk6IENka0RpZmZDYXRlZ29yeSkgPT5cbiAgKGlkOiBzdHJpbmcsIHJkaWZmOiBjZm5EaWZmLkRpZmZlcmVuY2U8YW55PikgPT4ge1xuICAgIGlmIChyZGlmZi5pc0RpZmZlcmVudCkge1xuICAgICAgY29uc3QgcmVzb3VyY2VUeXBlOiBzdHJpbmcgPSBndWFyZFJlc291cmNlRGlmZihyZGlmZilcbiAgICAgICAgPyAocmRpZmYuaXNSZW1vdmFsID8gcmRpZmYub2xkVmFsdWU/LlR5cGUgOiByZGlmZi5uZXdWYWx1ZT8uVHlwZSkgfHxcbiAgICAgICAgICBjZGtEaWZmQ2F0ZWdvcnlcbiAgICAgICAgOiAocmRpZmYub2xkVmFsdWU/LlR5cGUgfHwgcmRpZmYubmV3VmFsdWU/LlR5cGUgfHwgY2RrRGlmZkNhdGVnb3J5KTtcbiAgICAgIGNvbnN0IGNoYW5nZXM6IE5pY2VyRGlmZkNoYW5nZVtdID0gW107XG4gICAgICBpZiAoZ3VhcmRSZXNvdXJjZURpZmYocmRpZmYpICYmIHJkaWZmLmlzVXBkYXRlKSB7XG4gICAgICAgIHJkaWZmLmZvckVhY2hEaWZmZXJlbmNlKChfLCBsYWJlbCwgdmFsdWVzKSA9PiB7XG4gICAgICAgICAgY2hhbmdlcy5wdXNoKHtcbiAgICAgICAgICAgIGxhYmVsLFxuICAgICAgICAgICAgYWN0aW9uOiBidWlsZENoYW5nZUFjdGlvbih2YWx1ZXMub2xkVmFsdWUsIHZhbHVlcy5uZXdWYWx1ZSksXG4gICAgICAgICAgICBmcm9tOiB2YWx1ZXMub2xkVmFsdWUsXG4gICAgICAgICAgICB0bzogdmFsdWVzLm5ld1ZhbHVlLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgcmVzdWx0LnB1c2goe1xuICAgICAgICBsYWJlbDogY2RrRGlmZkNhdGVnb3J5LFxuICAgICAgICBjZGtEaWZmUmF3OiBKU09OLnN0cmluZ2lmeSh7IGlkLCBkaWZmOiByZGlmZiB9LCBudWxsLCAyKSxcbiAgICAgICAgbmljZXJEaWZmOiB7XG4gICAgICAgICAgcmVzb3VyY2VUeXBlLFxuICAgICAgICAgIGNoYW5nZXMsXG4gICAgICAgICAgY2RrRGlmZkNhdGVnb3J5LFxuICAgICAgICAgIHJlc291cmNlQWN0aW9uOiByZGlmZi5pc0FkZGl0aW9uXG4gICAgICAgICAgICA/IFwiQURESVRJT05cIlxuICAgICAgICAgICAgOiByZGlmZi5pc1JlbW92YWxcbiAgICAgICAgICAgID8gXCJSRU1PVkFMXCJcbiAgICAgICAgICAgIDogXCJVUERBVEVcIixcbiAgICAgICAgICByZXNvdXJjZUxhYmVsOiBpZCxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfTtcblxuY29uc3QgdHJhbnNmb3JtRGlmZkZvclJlc291cmNlVHlwZXMgPSBhc3luYyAoXG4gIGRpZmY6IFN0YWNrUmF3RGlmZlxuKTogUHJvbWlzZTxOaWNlckRpZmZbXT4gPT4ge1xuICBjb25zdCByZXN1bHQ6IE5pY2VyRGlmZltdID0gW107XG4gIGZvciAoY29uc3QgZCBvZiBPYmplY3QuZW50cmllcyhkaWZmLnJhd0RpZmYpLmZpbHRlcihcbiAgICAoW2tdKSA9PiAhW1wiaWFtQ2hhbmdlc1wiLCBcInNlY3VyaXR5R3JvdXBDaGFuZ2VzXCJdLmluY2x1ZGVzKGspXG4gICkpIHtcbiAgICBjb25zdCB7IGRpZmZDb2xsZWN0aW9uS2V5LCBkaWZmQ29sbGVjdGlvbiB9ID0gZGlmZlZhbGlkYXRvcihkKTtcbiAgICBpZiAoZGlmZkNvbGxlY3Rpb24uZGlmZmVyZW5jZUNvdW50ID4gMCkge1xuICAgICAgZGlmZkNvbGxlY3Rpb24uZm9yRWFjaERpZmZlcmVuY2UoXG4gICAgICAgIHByb2Nlc3NJbmRpdmlkdWFsRGlmZihyZXN1bHQsIGRpZmZDb2xsZWN0aW9uS2V5KVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufTtcblxuZXhwb3J0IGNvbnN0IHRyYW5zZm9ybURpZmYgPSBhc3luYyAoXG4gIGRpZmY6IFN0YWNrUmF3RGlmZlxuKTogUHJvbWlzZTxOaWNlclN0YWNrRGlmZj4gPT4ge1xuICBpZiAoZGlmZi5yYXdEaWZmLmlzRW1wdHkpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhY2tOYW1lOiBkaWZmLnN0YWNrTmFtZSxcbiAgICAgIHJhdzogXCJUaGVyZSB3ZXJlIG5vIGRpZmZlcmVuY2VzXCIsXG4gICAgICBkaWZmOiBbXSxcbiAgICB9O1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBzdGFja05hbWU6IGRpZmYuc3RhY2tOYW1lLFxuICAgIHJhdzogYXdhaXQgYnVpbGRSYXcoZGlmZiksXG4gICAgZGlmZjogW1xuICAgICAgLi4uKGF3YWl0IHRyYW5zZm9ybUlhbUNoYW5nZXMoZGlmZikpLFxuICAgICAgLi4uKGF3YWl0IHRyYW5zZm9ybVNlY3VyaXR5R3JvdXBDaGFuZ2VzKGRpZmYpKSxcbiAgICAgIC4uLihhd2FpdCB0cmFuc2Zvcm1EaWZmRm9yUmVzb3VyY2VUeXBlcyhkaWZmKSksXG4gICAgXSxcbiAgfTtcbn07XG4iXX0=